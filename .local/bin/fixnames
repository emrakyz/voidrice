#!/bin/sh

generate_unique_name() {
    base_name="$1"
    ext="$2"
    dest_path="$3"
    count=1

    if [ -z "$ext" ]; then
        new_name="$base_name"
    else
        new_name="${base_name}.${ext}"
    fi

    while [ -e "${dest_path}/${new_name}" ]; do
        if [ -z "$ext" ]; then
            new_name="${base_name}_${count}"
        else
            new_name="${base_name}_${count}.${ext}"
        fi
        count=$((count + 1))
    done

    echo "$new_name"
}

find . -depth -name '*' -print0 | xargs -0 -n1 -P8 -I{} sh -c '
    process_item() {
        item_path="$1"

        if [ "$item_path" = "." ]; then
            return
        fi

        dir_name=$(dirname "$item_path")
        base_name=$(basename "$item_path")

        if [ -d "$item_path" ]; then
            new_name=$(echo "$base_name" | sed "s/[^a-zA-Z0-9 _.-]//g; s/[ .-]/_/g; s/__*/_/g" | tr "[:upper:]" "[:lower:]" | sed "s/^_//")
            [ -z "$new_name" ] && new_name="untitled"
        else
            new_name=$(echo "$base_name" | sed "s/[^a-zA-Z0-9. _-]//g; s/[ .-]/_/g; s/__*/_/g; s/\(.*\)_\([^.]*\)\$/\1.\2/; s/^_//; s/_\././" | tr "[:upper:]" "[:lower:]")
            base_name_no_ext="${new_name%.*}"
            [ -z "$base_name_no_ext" ] && new_name="untitled.${new_name##*.}"
        fi

        if [ "$base_name" != "$new_name" ]; then
            if [ -e "${dir_name}/${new_name}" ]; then
                ext="${new_name##*.}"
                [ "$ext" == "$new_name" ] && ext=""
                new_name=$(generate_unique_name "${new_name%.*}" "$ext" "$dir_name")
            fi
            if ! mv "$item_path" "${dir_name}/${new_name}" 2>/dev/null; then
                echo "Error renaming $item_path to ${dir_name}/${new_name}"
            fi
        fi
    }

    process_item "$0"
' {} 2>/dev/null
